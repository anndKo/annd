<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kho l∆∞u tr·ªØ</title>

<style>
  #helpBtn {
    position: fixed;
    top: 15px;
    right: 15px;
    padding: 10px 18px;
    background: #ff9800;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    z-index: 11000;
}

#hideHelpBtn {
    position: fixed;
    top: 15px;
    right: 130px;
    padding: 10px 18px;
    background: #ca2222;
    color:white;
    border:none;
    border-radius:8px;
    font-size:16px;
    cursor:pointer;
    z-index:11000;
    font-weight: 600;
}

#helpOverlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.8);
    display: none;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    z-index: 12000;
}
#helpOverlay video {
    max-width: 90%;
    max-height: 80%;
    border-radius: 12px;
}
#closeHelp {
    margin-top: 20px;
    padding: 12px 20px;
    background: #e53935;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 18px;
    cursor: pointer;
}
body { font-family: sans-serif; padding: 20px; background: #4db391; }
h2 { margin-bottom: 10px; }
.btn { padding: 8px 14px; background: #2563eb; color: #fff; border: none; border-radius: 6px; cursor: pointer; margin: 5px; }
.btn:hover { background: #1e40af; }
input[type=text] { padding: 6px; border-radius: 5px; border: 1px solid #ccc; }
.thumb { max-width: 120px; margin: 5px; border-radius: 6px; cursor: pointer; }
.del { background: #dc2626; margin-top: 4px; }
.folder { background:#fff; padding:12px; border-radius:10px; margin-top:12px; box-shadow:0 4px 15px rgba(0,0,0,0.07);}
#header { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
#uploadPopup { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.4); display:none; justify-content:center; align-items:center; z-index:9999; }
#popupBox { background: #fff; padding: 20px; width: 360px; border-radius: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.3); }
#searchBar { padding: 8px; width: 300px; border-radius: 6px; border: 1px solid #aaa; margin-bottom: 20px; }
#imageOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; z-index:9999; }
#imageOverlay img { max-width:90%; max-height:90%; border-radius:10px; box-shadow:0 0 20px rgba(0,0,0,0.5); }
#imageOverlay .closeBtn, #imageOverlay .downloadBtn { position:absolute; top:20px; padding:10px 16px; font-size:16px; border:none; border-radius:6px; cursor:pointer; }
#imageOverlay .closeBtn { right:20px; background:#dc2626; color:#fff; }
#imageOverlay .downloadBtn { right:140px; background:#16a34a; color:#fff; }
.imageBox { background:#e7e7bc; padding:8px; border-radius:8px; margin:8px 0; width: fit-content; box-shadow:0 2px 6px rgba(0,0,0,0.12);}
[id^="images-"] { display:grid; grid-template-columns: repeat(2, auto); gap:12px; align-items:start;}
</style>
</head>

<body>
  <!-- N√öT ·∫®N DUY NH·∫§T -->
<button id="hideHelpBtn" onclick="hideHelpBtnFunction()">X</button>

<!-- N√öT H∆Ø·ªöNG D·∫™N -->
<button id="helpBtn" onclick="showHelp()">H∆∞·ªõng d·∫´n</button>

<!-- OVERLAY VIDEO -->
<div id="helpOverlay">
    <video id="helpVideo" controls>
        <source src="kho l∆∞u tr·ªØ.mp4" type="video/mp4">
    </video>
    <button id="closeHelp" onclick="closeHelp()">ƒê√≥ng</button>
</div>

<div id="header">
<h2>Kho l∆∞u tr·ªØ</h2>
<div>
<span id="userDisplay"></span>
<button class="btn" id="logoutBtn">ƒêƒÉng xu·∫•t</button>
</div>
</div>

<div style="width:100%; background-color:black; padding:10px; border-radius:5px; height:40px;">
<input id="searchBar" type="text" placeholder="T√¨m theo t√™n, lo·∫°i, ng√†y gi·ªù..." style="margin-top:5px;width: 70%;">
<label for="" style="background-color: #2563eb; color: white; padding: 10px;font-weight: 600;border-radius: 10px;font-family:Arial, Helvetica, sans-serif;">T√¨m</label>
</div>

<div style="width:100%; background-color:rgb(163, 8, 137); padding:10px; border-radius:5px; height:40px; margin-top:5px;">
<input type="text" id="folderNameInput" placeholder="Nh·∫≠p t√™n th∆∞ m·ª•c" style="height:20px; width:58%;">
<button class="btn" id="createFolderBtn" style="background-color: rgb(240,154,43); color:black; font-weight:600;">T·∫°o th∆∞ m·ª•c</button>
</div>

<div id="folderList"></div>

<!-- Popup upload -->
<div id="uploadPopup">
<div id="popupBox">
<h3>Th√¥ng tin ·∫£nh</h3>
<label>Lo·∫°i ·∫£nh:</label>
<select id="imgType" style="padding:6px; width:100%; border-radius:6px;">
<option value="C√° nh√¢n">C√° nh√¢n</option>
<option value="Nh√≥m">Kh√°c</option>
</select>
<br><br>
<label>ƒê·∫∑t t√™n (ƒë·ªÉ tr·ªëng ƒë·ªÉ l·∫•y t√™n file):</label>
<input id="imgTitle" type="text" placeholder="Nh·∫≠p t√™n ·∫£nh..." style="padding:6px; width:100%; border-radius:6px;">
<br><br>
<button class="btn" id="confirmUpload">X√°c nh·∫≠n</button>
<button class="btn del" onclick="closePopup()">H·ªßy</button>
</div>
</div>

<!-- Overlay ·∫£nh -->
<div id="imageOverlay">
<img id="fullImage" src="">
<button class="downloadBtn" id="downloadBtn">T·∫£i xu·ªëng</button>
<button class="closeBtn" onclick="closeOverlay()">ƒê√≥ng</button>
</div>

<script>
  function showHelp(){
    document.getElementById("helpOverlay").style.display = "flex";
    const v=document.getElementById("helpVideo");
    v.currentTime = 0;
    v.play();
}

function closeHelp(){
    document.getElementById("helpOverlay").style.display = "none";
    document.getElementById("helpVideo").pause();
}

// ·∫®N C·∫¢ 2 N√öT
function hideHelpBtnFunction(){
    document.getElementById("helpBtn").style.display = "none";
    document.getElementById("hideHelpBtn").style.display = "none";
}
/* ========== IndexedDB setup ========== */
const DB_NAME = "UserFolderDB";
const DB_VERSION = 1;
const STORE_NAME = "users";
let db;
let username = localStorage.getItem("dangnhap_hien_tai") || "testUser"; // demo

document.getElementById("userDisplay").textContent = username;
document.getElementById("logoutBtn").onclick = () => {
  localStorage.removeItem("dangnhap_hien_tai");
  window.location.href = "trangchu.html"; 
};


function openDB() {
  return new Promise((resolve,reject)=>{
    const request = indexedDB.open(DB_NAME, DB_VERSION);
    request.onupgradeneeded = e => {
      db = e.target.result;
      if(!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME,{keyPath:"username"});
    };
    request.onsuccess = e => { db = e.target.result; resolve(db); };
    request.onerror = reject;
  });
}

function getUserData() {
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(STORE_NAME,"readonly");
    const store = tx.objectStore(STORE_NAME);
    const req = store.get(username);
    req.onsuccess = ()=>resolve(req.result);
    req.onerror = reject;
  });
}

function putUserData(data) {
  return new Promise((resolve,reject)=>{
    const tx = db.transaction(STORE_NAME,"readwrite");
    const store = tx.objectStore(STORE_NAME);
    const req = store.put(data);
    req.onsuccess=()=>resolve();
    req.onerror=reject;
  });
}

/* ========== Th∆∞ m·ª•c ========== */
document.getElementById("createFolderBtn").onclick = async ()=>{
  const folderName = document.getElementById("folderNameInput").value.trim();
  if(!folderName) return alert("Nh·∫≠p t√™n th∆∞ m·ª•c");
  let data = await getUserData();
  if(!data) data={username,folders:[]};
  if(data.folders.find(f=>f.name===folderName)) return alert("T√™n th∆∞ m·ª•c ƒë√£ t·ªìn t·∫°i!");
  data.folders.unshift({name:folderName,images:[]});
  await putUserData(data);
  document.getElementById("folderNameInput").value="";
  loadFolders();
};

async function deleteFolder(name){
  if(!confirm("X√≥a th∆∞ m·ª•c n√†y?")) return;
  let data = await getUserData();
  data.folders = data.folders.filter(f=>f.name!==name);
  await putUserData(data);
  loadFolders();
}

/* ========== ·∫¢nh ========== */
let tempFiles = null;
let tempFolder = null;

function uploadImage(folderName){
  const fileInput = document.getElementById(`file-${encodeURIComponent(folderName)}`);
  tempFiles = fileInput.files;
  if(!tempFiles || tempFiles.length===0) return alert("Ch·ªçn ·∫£nh!");
  tempFolder = folderName;
  document.getElementById("uploadPopup").style.display="flex";
}

document.getElementById("confirmUpload").onclick = async ()=>{
  const type = document.getElementById("imgType").value;
  const titleInput = document.getElementById("imgTitle").value.trim();
  const data = await getUserData();
  const folder = data.folders.find(f=>f.name===tempFolder);
  for(let i=0;i<tempFiles.length;i++){
    const file = tempFiles[i];
    const reader = new FileReader();
    reader.onload = async (e)=>{
      folder.images.push({
        src:e.target.result,
        type,
        title: titleInput || file.name,
        datetime:new Date().toLocaleString("vi-VN")
      });
      await putUserData(data);
      loadFolders();
    };
    reader.readAsDataURL(file);
  }
  closePopup();
};

function closePopup(){ document.getElementById("uploadPopup").style.display="none"; document.getElementById("imgTitle").value=""; tempFiles=null; tempFolder=null; }

async function deleteImage(folderName,index){
  if(!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ·∫£nh n√†y?")) return;
  const data = await getUserData();
  const folder = data.folders.find(f=>f.name===folderName);
  folder.images.splice(index,1);
  await putUserData(data);
  loadFolders();
}

/* ========== Render th∆∞ m·ª•c & ·∫£nh ========== */
async function loadFolders(){
  const container = document.getElementById("folderList");
  container.innerHTML="";
  const data = await getUserData();
  if(!data || !data.folders) return;
  data.folders.forEach(folder=>{
    const safeName = encodeURIComponent(folder.name);
    const div = document.createElement("div");
    div.className="folder";
    div.innerHTML=`
      <h3>üìÇ ${folder.name} <span id="count-${safeName}" style="color:blue;font-size:14px;">(${folder.images.length} ·∫£nh)</span>
      <button class="btn del" onclick="deleteFolder('${folder.name}')">X√≥a th∆∞ m·ª•c</button></h3>
      <input type="file" id="file-${safeName}" accept="image/*" multiple style="display:none">
      <label for="file-${safeName}" class="btn">Ch·ªçn ·∫£nh</label>
      <button class="btn" onclick="uploadImage('${folder.name}')">T·∫£i ·∫£nh</button>
      <div id="images-${safeName}"></div>
    `;
    container.appendChild(div);
    renderImages(folder.name,folder.images);
  });
}

function renderImages(folderName,images){
  const wrap = document.getElementById("images-"+encodeURIComponent(folderName));
  wrap.innerHTML="";
  images.forEach((imgData,idx)=>{
    const box=document.createElement("div"); box.className="imageBox";
    const img=document.createElement("img"); img.src=imgData.src; img.className="thumb";
    img.onclick=()=>openOverlay(imgData);
    const info=document.createElement("div");
    info.innerHTML=`<small><b>T√™n:</b> ${imgData.title}</small><br>
                    <small><b>Lo·∫°i:</b> ${imgData.type}</small><br>
                    <small><b>Ng√†y gi·ªù:</b> ${imgData.datetime}</small><br>`;
    const delBtn=document.createElement("button"); delBtn.className="btn del"; delBtn.innerText="X√≥a";
    delBtn.onclick=()=>deleteImage(folderName,idx);
    box.append(img,info,delBtn);
    wrap.appendChild(box);
  });
  updateImageCount(folderName);
}

/* ========== Overlay ·∫£nh ========== */
function openOverlay(imgData){
  const overlay=document.getElementById("imageOverlay");
  const fullImg=document.getElementById("fullImage");
  fullImg.src=imgData.src; overlay.style.display="flex";
  document.getElementById("downloadBtn").onclick=()=>{ const a=document.createElement("a"); a.href=imgData.src; a.download=imgData.title+".png"; a.click();};
}
function closeOverlay(){ document.getElementById("imageOverlay").style.display="none"; }

/* ========== T√¨m ki·∫øm ========== */
/* ========== T√¨m ki·∫øm ========== */
document.getElementById("searchBar").oninput = async function () {
  const key = this.value.toLowerCase().trim();
  const data = await getUserData();
  if (!data || !data.folders) return;

  data.folders.forEach(folder => {
    const safeName = encodeURIComponent(folder.name);

    // L·∫•y folderBox theo c√°ch t∆∞∆°ng th√≠ch M·ªåI TR√åNH DUY·ªÜT
    const folderBox = document.getElementById("images-" + safeName).parentElement;

    const images = folder.images;

    // N·∫øu thanh t√¨m ki·∫øm tr·ªëng ‚Üí hi·ªán t·∫•t c·∫£
    if (key === "") {
      folderBox.style.display = "";
      renderImages(folder.name, images);
      return;
    }

    // T√¨m theo t√™n th∆∞ m·ª•c
    const folderMatch = folder.name.toLowerCase().includes(key);

    // L·ªçc ·∫£nh theo T√äN + LO·∫†I + NG√ÄY GI·ªú
    const filteredImages = images.filter(img =>
      img.title.toLowerCase().includes(key) ||
      img.type.toLowerCase().includes(key) ||
      img.datetime.toLowerCase().includes(key)
    );

    // N·∫øu t√™n th∆∞ m·ª•c kh·ªõp
    if (folderMatch) {
      folderBox.style.display = "";
      renderImages(folder.name, images);
    }
    // N·∫øu c√≥ ·∫£nh kh·ªõp
    else if (filteredImages.length > 0) {
      folderBox.style.display = "";
      renderImages(folder.name, filteredImages);
    }
    // Kh√¥ng kh·ªõp g√¨ ‚Üí ·∫©n
    else {
      folderBox.style.display = "none";
    }
  });
};


/* ========== C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng ·∫£nh ========== */
function updateImageCount(folderName){
  const wrap=document.getElementById("images-"+encodeURIComponent(folderName));
  const countSpan=document.getElementById("count-"+encodeURIComponent(folderName));
  if(!wrap||!countSpan) return;
  countSpan.textContent=`(${wrap.querySelectorAll(".imageBox").length} ·∫£nh)`;
}

/* ========== Kh·ªüi t·∫°o DB ========== */
openDB().then(loadFolders).catch(console.error);
</script>
</body>
</html>
