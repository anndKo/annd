<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>C√¥ng c·ª• l√†m n√©t ·∫£nh chuy√™n nghi·ªáp</title>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #eef2f7;
  margin: 0; padding: 20px;
}

.container {
  max-width: 1200px;
  margin: auto;
  background: white;
  padding: 20px;
  border-radius: 14px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.15);
}

h1 {
  text-align: center;
  background: linear-gradient(to right,#4facfe,#00f2fe);
  color: white;
  padding: 14px;
  border-radius: 10px;
}

.upload-btn {
  display: inline-block;
  background: #0b69ff;
  padding: 10px 16px;
  color: white;
  border-radius: 8px;
  cursor: pointer;
  margin-bottom: 10px;
}

#file { display: none; }

.toolbox {
  display: flex;
  gap: 14px;
  flex-wrap: wrap;
  margin-top: 20px;
}

.tool {
  flex: 1;
  min-width: 220px;
}

.tool label { font-weight: 600; display: block; margin-bottom: 6px; }
.tool span { float: right; font-weight: normal; color: #555; }

.tool input[type=range] {
  width: 100%;
}

.canvas-wrapper {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  align-items: flex-start;
  gap: 20px;
  margin-top: 25px;
  flex-wrap: nowrap;
}

.canvas-wrapper > div { width: 50%; }

canvas {
  width: 100%;
  height: auto;
  border-radius: 10px;
  cursor: pointer;
}

#previewOverlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.85);
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

#previewOverlay img { max-width: 95%; max-height: 95%; border-radius: 10px; }
#closePreview {
  position: absolute;
  top: 20px;
  right: 25px;
  background: rgba(255,255,255,0.8);
  padding: 8px 14px;
  border-radius: 8px;
  font-size: 18px;
  cursor: pointer;
}

button {
  padding: 10px 16px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  margin-right: 10px;
}

.primary { background: #0b69ff; color: white; }
.secondary { background: #e0e3ff; color: #0b69ff; }
.danger { background: #ff4d4d; color: white; }
</style>
</head>

<body>

<div class="container">

<h1>C√¥ng c·ª• l√†m n√©t & ch·ªânh s·ª≠a ·∫£nh chuy√™n nghi·ªáp</h1>

<label class="upload-btn" for="file">üì§ T·∫£i ·∫£nh l√™n</label>
<input id="file" type="file" accept="image/*">

<div class="toolbox">

  <div class="tool">
    <label>ƒê·ªô m·∫°nh l√†m n√©t <span id="sharpenVal">1</span></label>
    <input id="sharpen" type="range" min="0" max="3" step="0.01" value="1">
  </div>

  <div class="tool">
    <label>Chi·ªÅu s√¢u l√†m n√©t <span id="radiusVal">2</span></label>
    <input id="radius" type="range" min="0" max="10" step="0.5" value="2">
  </div>

  <div class="tool">
    <label>ƒê·ªô s√°ng <span id="brightnessVal">0</span></label>
    <input id="brightness" type="range" min="-100" max="100" value="0">
  </div>

  <div class="tool">
    <label>ƒê·ªô t∆∞∆°ng ph·∫£n <span id="contrastVal">0</span></label>
    <input id="contrast" type="range" min="-100" max="100" value="0">
  </div>

  <div class="tool">
    <label>B√£o h√≤a m√†u <span id="saturationVal">0</span></label>
    <input id="saturation" type="range" min="-100" max="100" value="0">
  </div>

  <div class="tool">
    <label>L√†m m·ªãn ·∫£nh <span id="smoothVal">0</span></label>
    <input id="smooth" type="range" min="0" max="10" value="0">
  </div>

  <div class="tool">
    <label>Gi·∫£m nhi·ªÖu (Denoise) <span id="denoiseVal">0</span></label>
    <input id="denoise" type="range" min="0" max="10" value="0">
  </div>

  <div class="tool">
  <label>ƒê·ªô n√©t AI  <span id="asharpVal">100%</span></label>
  <input id="aiSharpen" type="range" min="0" max="300" value="100">
</div>
</div>

<div class="buttons">
  <button id="applyBtn" class="primary">‚ú® √Åp d·ª•ng ch·ªânh s·ª≠a</button>
  <button id="resetBtn" class="danger">üîÑ Reset ·∫£nh</button>
  <button id="downloadBtn" class="secondary">‚¨áÔ∏è T·∫£i xu·ªëng</button>
</div>

<div class="canvas-wrapper">
  <div>
    <p><b>·∫¢nh g·ªëc</b></p>
    <canvas id="origCanvas"></canvas>
  </div>
  <div>
    <p><b>·∫¢nh ƒë√£ ch·ªânh s·ª≠a</b></p>
    <canvas id="editCanvas"></canvas>
  </div>
</div>

</div><!-- container -->

<div id="previewOverlay">
  <div id="closePreview">‚úñ</div>
  <img id="previewImage" src="">
</div>

<script>
const fileInput = document.getElementById('file');
const origCanvas = document.getElementById('origCanvas');
const editCanvas = document.getElementById('editCanvas');
const previewOverlay = document.getElementById('previewOverlay');
const previewImg = document.getElementById('previewImage');
const closePreview = document.getElementById('closePreview');

const ctxO = origCanvas.getContext('2d');
const ctxE = editCanvas.getContext('2d');

let img = new Image();

function loadImage(url){
  img.onload = () => {
    origCanvas.width = img.width;
    origCanvas.height = img.height;
    editCanvas.width = img.width;
    editCanvas.height = img.height;

    ctxO.drawImage(img,0,0,img.width,img.height);
    ctxE.drawImage(img,0,0,img.width,img.height);
  };
  img.src = url;
}

fileInput.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  loadImage(URL.createObjectURL(file));
});

// Input elements
const sharpen = document.getElementById('sharpen');
const radius = document.getElementById('radius');
const brightness = document.getElementById('brightness');
const contrast = document.getElementById('contrast');
const saturation = document.getElementById('saturation');
const smooth = document.getElementById('smooth');
const denoise = document.getElementById('denoise');
const aiSharpen = document.getElementById('aiSharpen');

// Display value spans
const sharpenVal = document.getElementById('sharpenVal');
const radiusVal = document.getElementById('radiusVal');
const brightnessVal = document.getElementById('brightnessVal');
const contrastVal = document.getElementById('contrastVal');
const saturationVal = document.getElementById('saturationVal');
const smoothVal = document.getElementById('smoothVal');
const denoiseVal = document.getElementById('denoiseVal');
const aiSharpenVal = document.getElementById('asharpVal');

// Update displayed values
[sharpen, radius, brightness, contrast, saturation, smooth, denoise, aiSharpen].forEach(input=>{
  input.addEventListener('input', ()=> {
    document.getElementById(input.id+'Val').innerText = input.value + (input===aiSharpen?'%':'');
    applyFilter();
  });
});

// Helper: Convolution filter
function convolution(imgData, kernel, factor=1, bias=0){
  const d = imgData.data;
  const w = imgData.width;
  const h = imgData.height;
  const copy = new Uint8ClampedArray(d);
  const side = Math.sqrt(kernel.length);
  const half = Math.floor(side/2);

  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      for(let c=0;c<3;c++){
        let sum = 0;
        for(let ky=0;ky<side;ky++){
          for(let kx=0;kx<side;kx++){
            let px = x + kx - half;
            let py = y + ky - half;
            if(px>=0 && px<w && py>=0 && py<h){
              let idx = (py*w + px)*4 + c;
              sum += copy[idx]*kernel[ky*side + kx];
            }
          }
        }
        let idx = (y*w+x)*4 + c;
        d[idx] = Math.min(255,Math.max(0,factor*sum + bias));
      }
    }
  }
  return imgData;
}

// Generate sharpening kernel dynamically
function getSharpenKernel(amount, radius){
  const size = Math.max(3, Math.floor(radius)*2+1);
  const kernel = new Array(size*size).fill(-amount/(size*size));
  const center = Math.floor(size*size/2);
  kernel[center] = 1 + amount;
  return kernel;
}

// Apply filters
function applyFilter(){
  ctxE.drawImage(origCanvas,0,0);

  let imageData = ctxE.getImageData(0,0,editCanvas.width,editCanvas.height);
  let d = imageData.data;

  let br = parseInt(brightness.value);
  let ct = parseInt(contrast.value);
  let sat = parseInt(saturation.value);
  let sm = parseInt(smooth.value);
  let dn = parseInt(denoise.value);
  let aiSh = parseFloat(aiSharpen.value)/100; // scale 0-3

  let factor = (259 * (ct + 255)) / (255 * (259 - ct));

  // Brightness, contrast, saturation
  for(let i=0;i<d.length;i+=4){
    let r=d[i], g=d[i+1], b=d[i+2];

    r += br; g += br; b += br;
    r = factor*(r-128)+128;
    g = factor*(g-128)+128;
    b = factor*(b-128)+128;

    let avg = (r+g+b)/3;
    r = avg + (r - avg)*(1 + sat/100);
    g = avg + (g - avg)*(1 + sat/100);
    b = avg + (b - avg)*(1 + sat/100);

    d[i] = Math.min(255,Math.max(0,r));
    d[i+1] = Math.min(255,Math.max(0,g));
    d[i+2] = Math.min(255,Math.max(0,b));
  }

  ctxE.putImageData(imageData,0,0);

  // Smooth / denoise: use mild Gaussian blur
  let totalBlur = sm + dn;
  if(totalBlur>0){
    ctxE.filter = `blur(${totalBlur/3}px)`; // scale down to avoid m·ªù qu√°
    ctxE.drawImage(editCanvas,0,0);
    ctxE.filter = "none";
  }

  // AI Sharpen using convolution
  let amount = parseFloat(sharpen.value) + aiSh;
  let rad = parseFloat(radius.value);

  if(amount>0){
    let imgData = ctxE.getImageData(0,0,editCanvas.width,editCanvas.height);
    let kernel = getSharpenKernel(amount, rad);
    let out = convolution(imgData,kernel);
    ctxE.putImageData(out,0,0);
  }
}

// Apply button
document.getElementById('applyBtn').addEventListener('click', applyFilter);

// Reset
document.getElementById('resetBtn').addEventListener('click', ()=>{
  ctxE.drawImage(origCanvas,0,0);
  [sharpen, radius, brightness, contrast, saturation, smooth, denoise, aiSharpen].forEach(input=>{
    document.getElementById(input.id+'Val').innerText = input.value + (input===aiSharpen?'%':'');
  });
});

// Download
document.getElementById('downloadBtn').addEventListener('click', ()=>{
  editCanvas.toBlob(blob=>{
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = "anh-da-chinh-sua.png";
    a.click();
  });
});

// Fullscreen preview
function openPreview(canvas){
  previewImg.src = canvas.toDataURL();
  previewOverlay.style.display = "flex";
}
origCanvas.onclick = ()=>openPreview(origCanvas);
editCanvas.onclick = ()=>openPreview(editCanvas);
closePreview.onclick = ()=> previewOverlay.style.display="none";
</script>

</body>
</html>
