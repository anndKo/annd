<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>C√¥ng c·ª• l√†m n√©t ·∫£nh chuy√™n nghi·ªáp</title>
<style>
body { font-family: system-ui, sans-serif; background: #eef2f7; margin:0; padding:20px;}
.container { max-width:1200px; margin:auto; background:white; padding:20px; border-radius:14px; box-shadow:0 8px 20px rgba(0,0,0,0.15);}
h1 { text-align:center; background: linear-gradient(to right,#4facfe,#00f2fe); color:white; padding:14px; border-radius:10px;}
.upload-btn { display:inline-block; background:#0b69ff; padding:10px 16px; color:white; border-radius:8px; cursor:pointer; margin-bottom:10px;}
#file{display:none;}
.toolbox { display:flex; gap:14px; flex-wrap:wrap; margin-top:20px;}
.tool { flex:1; min-width:220px;}
.tool label{font-weight:600; display:block; margin-bottom:6px;}
.tool span{float:right; font-weight:normal; color:#555;}
.tool input[type=range]{width:100%;}
.canvas-wrapper{ display:flex; flex-direction:row; justify-content:space-between; align-items:flex-start; gap:20px; margin-top:25px; flex-wrap:nowrap;}
.canvas-wrapper>div{width:50%;}
canvas{width:100%; height:auto; border-radius:10px; cursor:pointer;}
#previewOverlay{display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); justify-content:center; align-items:center; z-index:9999;}
#previewOverlay img{max-width:95%; max-height:95%; border-radius:10px;}
#closePreview{position:absolute; top:20px; right:25px; background:rgba(255,255,255,0.8); padding:8px 14px; border-radius:8px; font-size:18px; cursor:pointer;}
button{padding:10px 16px; border:none; border-radius:8px; cursor:pointer; margin-right:10px;}
.primary{background:#0b69ff;color:white;}
.secondary{background:#e0e3ff;color:#0b69ff;}
.danger{background:#ff4d4d;color:white;}
</style>
</head>
<body>
<div class="container">
<h1>C√¥ng c·ª• l√†m n√©t & ch·ªânh s·ª≠a ·∫£nh</h1>
<label class="upload-btn" for="file">üì§ T·∫£i ·∫£nh l√™n</label>
<input id="file" type="file" accept="image/*">

<div class="toolbox">
  <div class="tool">
    <label>ƒê·ªô m·∫°nh l√†m n√©t <span id="sharpenVal">1</span></label>
    <input id="sharpen" type="range" min="0" max="3" step="0.01" value="1">
  </div>
  <div class="tool">
    <label>Chi·ªÅu s√¢u l√†m n√©t <span id="radiusVal">2</span></label>
    <input id="radius" type="range" min="0" max="10" step="0.5" value="2">
  </div>
  <div class="tool">
    <label>ƒê·ªô s√°ng <span id="brightnessVal">0</span></label>
    <input id="brightness" type="range" min="-100" max="100" value="0">
  </div>
  <div class="tool">
    <label>Gi·∫£m nhi·ªÖu (Denoise) <span id="denoiseVal">0</span></label>
    <input id="denoise" type="range" min="0" max="10" value="0">
  </div>
</div>

<div class="buttons">
  <button id="resetBtn" class="danger">üîÑ Reset ·∫£nh</button>
  <button id="downloadBtn" class="secondary">‚¨áÔ∏è T·∫£i xu·ªëng</button>
</div>

<div class="canvas-wrapper">
  <div>
    <p><b>·∫¢nh g·ªëc</b></p>
    <canvas id="origCanvas"></canvas>
  </div>
  <div>
    <p><b>·∫¢nh ƒë√£ ch·ªânh s·ª≠a</b></p>
    <canvas id="editCanvas"></canvas>
  </div>
</div>
</div>

<div id="previewOverlay">
  <div id="closePreview">‚úñ</div>
  <img id="previewImage" src="">
</div>

<script>
const fileInput = document.getElementById('file');
const origCanvas = document.getElementById('origCanvas');
const editCanvas = document.getElementById('editCanvas');
const ctxO = origCanvas.getContext('2d');
const ctxE = editCanvas.getContext('2d');

let img = new Image();

function loadImage(url){
  img.onload = () => {
    origCanvas.width = img.width;
    origCanvas.height = img.height;
    editCanvas.width = img.width;
    editCanvas.height = img.height;
    ctxO.drawImage(img,0,0);
    ctxE.drawImage(img,0,0);
  };
  img.src = url;
}

fileInput.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;
  loadImage(URL.createObjectURL(file));
});

// Inputs
const sharpen = document.getElementById('sharpen');
const radius = document.getElementById('radius');
const brightness = document.getElementById('brightness');
const denoise = document.getElementById('denoise');
const sharpenVal = document.getElementById('sharpenVal');
const radiusVal = document.getElementById('radiusVal');
const brightnessVal = document.getElementById('brightnessVal');
const denoiseVal = document.getElementById('denoiseVal');

// C·∫≠p nh·∫≠t gi√° tr·ªã v√† apply ngay
[sharpen,radius,brightness,denoise].forEach(input=>{
  input.addEventListener('input', ()=>{
    document.getElementById(input.id+'Val').innerText = input.value;
    applyFilter();
  });
});

// Convolution & Sharpen
function convolution(imgData, kernel){
  const d = imgData.data;
  const w = imgData.width;
  const h = imgData.height;
  const copy = new Uint8ClampedArray(d);
  const size = Math.sqrt(kernel.length);
  const half = Math.floor(size/2);
  for(let y=0;y<h;y++){
    for(let x=0;x<w;x++){
      for(let c=0;c<3;c++){
        let sum=0;
        for(let ky=0;ky<size;ky++){
          for(let kx=0;kx<size;kx++){
            let px = x+kx-half;
            let py = y+ky-half;
            if(px>=0 && px<w && py>=0 && py<h){
              let idx=(py*w+px)*4+c;
              sum+=copy[idx]*kernel[ky*size+kx];
            }
          }
        }
        let idx=(y*w+x)*4+c;
        d[idx]=Math.min(255,Math.max(0,sum));
      }
    }
  }
  return imgData;
}

function getSharpenKernel(amount,radius){
  const size = Math.max(3,Math.floor(radius)*2+1);
  const kernel = new Array(size*size).fill(-amount/(size*size));
  kernel[Math.floor(size*size/2)] = 1+amount;
  return kernel;
}

function applyFilter(){
  ctxE.drawImage(origCanvas,0,0);
  let imgData = ctxE.getImageData(0,0,editCanvas.width,editCanvas.height);
  let d = imgData.data;

  // Brightness
  let br = parseInt(brightness.value);
  for(let i=0;i<d.length;i+=4){
    d[i]=Math.min(255,Math.max(0,d[i]+br));
    d[i+1]=Math.min(255,Math.max(0,d[i+1]+br));
    d[i+2]=Math.min(255,Math.max(0,d[i+2]+br));
  }
  ctxE.putImageData(imgData,0,0);

  // Denoise/blur
  let dn = parseInt(denoise.value);
  if(dn>0){
    ctxE.filter = `blur(${dn/2}px)`;
    ctxE.drawImage(editCanvas,0,0);
    ctxE.filter = 'none';
  }

  // Sharpen
  let amount = parseFloat(sharpen.value);
  let rad = parseFloat(radius.value);
  if(amount>0){
    let data = ctxE.getImageData(0,0,editCanvas.width,editCanvas.height);
    let kernel = getSharpenKernel(amount, rad);
    ctxE.putImageData(convolution(data,kernel),0,0);
  }
}

// Reset
document.getElementById('resetBtn').addEventListener('click', ()=>{
  ctxE.drawImage(origCanvas,0,0);
  [sharpen,radius,brightness,denoise].forEach(input=>{
    document.getElementById(input.id+'Val').innerText = input.value;
  });
});

// Download
document.getElementById('downloadBtn').addEventListener('click', ()=>{
  editCanvas.toBlob(blob=>{
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download="anh-da-chinh-sua.png";
    a.click();
  });
});

// Fullscreen preview
const previewOverlay = document.getElementById('previewOverlay');
const previewImg = document.getElementById('previewImage');
const closePreview = document.getElementById('closePreview');

function openPreview(canvas){
  previewImg.src = canvas.toDataURL();
  previewOverlay.style.display = "flex";
}

origCanvas.onclick = ()=>openPreview(origCanvas);
editCanvas.onclick = ()=>openPreview(editCanvas);
closePreview.onclick = ()=>previewOverlay.style.display="none";
</script>
</body>
</html>
